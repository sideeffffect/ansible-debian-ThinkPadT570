---

- hosts: debian-ThinkPadT570

  vars:
    firefox:
      addons:
        - url: https://addons.mozilla.org/en-US/firefox/addon/https-everywhere
        - url: https://addons.mozilla.org/en-US/firefox/addon/ublock-origin
        - url: https://addons.mozilla.org/en-US/firefox/addon/tree-style-tab
        - url: https://addons.mozilla.org/en-US/firefox/addon/google-search-link-fix
        - url: https://addons.mozilla.org/en-US/firefox/addon/firegestures
        - url: https://addons.mozilla.org/en-US/firefox/addon/stylish
        - url: https://addons.mozilla.org/en-US/firefox/addon/reddit-enhancement-suite
        - url: https://addons.mozilla.org/en-US/firefox/addon/tab-mix-plus
        - url: https://addons.mozilla.org/en-US/firefox/addon/gnotifier
      prefs:
        - name: browser.tabs.animate
          value: false
        - name: browser.startup.page
          value: 3
        - name: extensions.treestyletab.autoCollapseExpandSubtreeOnAttach
          value: false
        - name: extensions.treestyletab.tooltip.mode
          value: 0
        - name: accessibility.typeaheadfind
          value: true
        - name: browser.sessionstore.restore_on_demand
          value: false
        - name: extensions.tabmix.currentTab
          value: true
        - name: browser.tabs.remote.autostart
          value: true
        - name: browser.tabs.remote.force-enable
          value: true
        - name: dom.ipc.processCount
          value: 99
        - name: dom.ipc.processCount.extension
          value: 99
        - name: middlemouse.contentLoadURL
          value: false
        - name: extensions.tabmix.currentTab
          value: true
        - name: extensions.tabmix.otherTab
          value: true
        - name: browser.disableResetPrompt
          value: true
      styles:
        - https://userstyles.org/styles/92693/dark-hacker-news-solarized
        - https://userstyles.org/styles/118959/darksearch-for-google
        - https://userstyles.org/styles/37035/github-dark
        - https://userstyles.org/styles/108591/github-wide
        - https://userstyles.org/styles/122072/wikipedia-minimalistic-dark-material-design
        - https://userstyles.org/styles/25811/amo-dark-theme
        - https://userstyles.org/styles/35345/stackoverflow-dark
        - https://userstyles.org/styles/120595/gmail-dark-1
    
    packages_add:
      - acroread:i386
      - acroread-plugins:i386
      - ansible
      - aptitude
      - aspell-cs
      - bash-completion
      - code                # Visual Studio Code
      - curl
      - dconf-editor
      - deluge-console
      - deluge-gtk
      - docker-ce
      - ffmpeg
      - firefox
      - firefox-l10n-cs
      - firmware-intel-sound
      - firmware-iwlwifi
      - firmware-linux
      - fish
      - flac
      - flatpak
      - fonts-noto
      - fsharp
      - gconf2
      - genisoimage
      - git
      - gitg
      - glances
      - gnome-shell-extension-move-clock
      - gnome-shell-extension-system-monitor
      - gnome-shell-extension-weather
      - gnome-software-plugin-flatpak
      - gnome-themes-standard:i386
      - gnome-tweak-tool
      - google-chrome-stable
      - gstreamer1.0-packagekit
      - gstreamer1.0-vaapi
      - gtk2-engines-murrine
      - guake
      - heimdall-flash-frontend
      - hunspell-cs
      - hyphen-cs
      - latexmk
      - lib32stdc++6
      - libatk-adaptor:i386
      - libcanberra-gtk-module
      - libcanberra-gtk-module:i386
      - libjson-perl        #ctstream
      - liblttng-ust0       # .NET core
      - libpam-fprintd
      - libreoffice-help-cs
      - libreoffice-l10n-cs
      - libunwind8          # .NET core
      - libxml-xpath-perl   #ctstream
      - libxml2-utils
      - liferea
      - mono-complete
      - mtr-tiny
      - mythes-cs
      - network-manager-openvpn-gnome
      - npm                 # F# fable
      - openjdk-8-jdk
      - openjfx
      - picard
      - plymouth
      - plymouth-themes
      - python-jsonpath-rw
      - python-pip
      - python3-pip
      - sbt
      - shntool
      - snapper
      - sudo
      - texlive
      - texlive-lang-czechslovak
      - texlive-lang-english
      - texlive-luatex
      - texlive-xetex
      - tree
      - unrar
      - vim-nox
      - vlc
      - xinput
    packages_repos:
      - repo: deb http://deb.debian.org/debian testing main contrib non-free
      - repo: deb http://deb.debian.org/debian testing-updates main contrib non-free
      - repo: deb http://deb.debian.org/debian unstable main
      - repo: deb http://security.debian.org/ testing/updates main contrib non-free
      - repo: deb-src http://deb.debian.org/debian testing main contrib non-free
      - repo: deb-src http://deb.debian.org/debian testing-updates main contrib non-free
      - repo: deb-src http://security.debian.org/ testing/updates main contrib non-free
      - repo: deb http://www.deb-multimedia.org testing main non-free
        key: "http://keyserver.ubuntu.com/pks/lookup?op=get&search=0xA401FF99368FA1F98152DE755C808C2B65558117"
      - repo: deb http://download.mono-project.com/repo/debian wheezy main
        key: "http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF"
      - repo: deb https://dl.bintray.com/sbt/debian /
        key: "http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823"
      - repo: deb https://dl.google.com/linux/chrome/deb/ stable main
        key: "https://dl.google.com/linux/linux_signing_key.pub"
      - repo: deb http://packages.microsoft.com/repos/vscode stable main
        key: "https://packages.microsoft.com/keys/microsoft.asc"
      - repo: deb https://download.docker.com/linux/debian stretch stable
        key: "https://download.docker.com/linux/debian/gpg"
  
  pre_tasks:
    - name: Debian repos -- supress unstable packages except Firefox
      become: yes
      copy:
        content: |
          Package: firefox*
          Pin: release a=unstable
          Pin-Priority: 600
          
          Package: *
          Pin: release a=unstable
          Pin-Priority: 50
        dest: /etc/apt/preferences.d/unstable

    - name: Debian repos -- i386 architecture
      become: yes
      command: dpkg --add-architecture i386
    
    - name: Debian repos -- https support
      become: yes
      package:
        name: apt-transport-https
        state: present
  
  post_tasks:
    - name: Debian repos -- remove old sources.list
      become: yes
      file:
        path: /etc/apt/sources.list
        state: absent

    - name: /tmp in RAM -- tmp.mount available
      become: yes
      copy:
        src: /usr/share/systemd/tmp.mount
        dest: /etc/systemd/system/
    
    - name: /tmp in RAM -- enable in systemd
      become: yes
      systemd:
        name: tmp.mount
        enabled: yes
    
    - name: Snapper -- enable timelines and cleanup
      become: yes
      systemd:
        name: snapper-{{ item }}.timer
        enabled: yes
      with_items:
        - timeline
        - cleanup
    
    - name: Download AnotherCountrySunset wallpaper
      get_url:
        url: http://ftp.gnome.org/pub/GNOME/teams/art.gnome.org/backgrounds/NATURE-AnotherCountrySunset_1920x1200.jpg
        dest: '~/Pictures/NATURE-AnotherCountrySunset_1920x1200.jpg'
    
    - name: Fonts -- directory
      file:
        path: '~/.local/share/fonts'
        state: directory
    
    - name: Fonts -- Fira Code -- download
      get_url:
        url: https://github.com/tonsky/FiraCode/blob/master/distr/ttf/FiraCode-{{ item }}.ttf?raw=true
        dest: '~/.local/share/fonts/FiraCode-{{ item }}.ttf'
      with_items:
        - Bold
        - Light
        - Medium
        - Regular
        - Retina

    - name: gconf
      gconftool2:
        key: '{{ item.key }}'
        value: '{{ item.value }}'
        value_type: '{{ item.type }}'
        state: present
      with_items:
        - { key: /apps/guake/keybindings/global/show_hide, value: "<Shift>space", type: string }

    - name: gsettings
      command: gsettings set {{ item }}
      with_items:
        - net.sf.liferea default-view-mode 1
        - net.sf.liferea disable-toolbar true
        - net.sf.liferea.plugins active-plugins "['media-player', 'gnome-keyring']"
        
        - org.freedesktop.Tracker.Extract sched-idle 'always'
        - org.freedesktop.Tracker.Miner.Files sched-idle 'always'
        
        - org.gnome.Terminal.Legacy.Settings new-terminal-mode 'tab'
        
        - org.gnome.desktop.background picture-uri '~/Pictures/NATURE-AnotherCountrySunset_1920x1200.jpg'
        - org.gnome.desktop.datetime automatic-timezone true
        - org.gnome.desktop.interface clock-show-date true
        - org.gnome.desktop.interface clock-show-seconds true
        - org.gnome.desktop.interface document-font-name 'DejaVu Sans 12'
        - org.gnome.desktop.interface font-name 'DejaVu Sans 12'
        - org.gnome.desktop.interface monospace-font-name 'Fira Code Light 12'
        - org.gnome.desktop.wm.preferences titlebar-font 'DejaVu Sans Bold 12'
        
        - org.gnome.gedit.preferences.editor auto-indent true
        - org.gnome.gedit.preferences.editor bracket-matching true
        - org.gnome.gedit.preferences.editor display-line-numbers true
        - org.gnome.gedit.preferences.editor display-overview-map true
        - org.gnome.gedit.preferences.editor display-right-margin true
        - org.gnome.gedit.preferences.editor highlight-current-line true
        - org.gnome.gedit.preferences.editor insert-spaces true
        - org.gnome.gedit.preferences.editor scheme 'oblivion'
        - org.gnome.gedit.preferences.editor tabs-size 2
        - org.gnome.gedit.preferences.ui show-tabs-mode 'auto'
        
        - org.gnome.settings-daemon.plugins.xsettings antialiasing 'rgba'
        - org.gnome.settings-daemon.plugins.xsettings hinting 'full'
        
        - org.gnome.settings-daemon.plugins.color night-light-enabled true
        
        - org.gnome.shell enabled-extensions "['Move_Clock@jonathan.bluemosh.com', 'openweather-extension@jenslody.de', 'system-monitor@paradoxxx.zero.gmail.com', 'auto-move-windows@gnome-shell-extensions.gcampax.github.com']"
        - org.gnome.shell favorite-apps "['firefox.desktop', 'google-chrome.desktop', 'evolution.desktop', 'net.sourceforge.liferea.desktop', 'rhythmbox.desktop', 'org.gnome.Nautilus.desktop']"
        - org.gnome.shell.app-switcher current-workspace-only true
        
        - org.gnome.shell.extensions.auto-move-windows application-list "['firefox.desktop:1', 'google-chrome.desktop:1', 'evolution.desktop:2', 'net.sourceforge.liferea.desktop:3', 'rhythmbox.desktop:4']"
        
        - org.gnome.shell.extensions.openweather city '50.0596288,14.446459273258>Praha, Česko >-1'
        - org.gnome.shell.extensions.openweather position-in-panel 'right'
        - org.gnome.shell.extensions.openweather pressure-unit 'kPa'
        - org.gnome.shell.extensions.openweather unit 'celsius'
        - org.gnome.shell.extensions.openweather wind-speed-unit 'm/s'
        
        - org.gtk.Settings.FileChooser sort-directories-first true
    
    - name: Fonts -- Xresources
      copy:
        content: |
          Xft.autohint: 0
          Xft.antialias: 1
          Xft.dpi: 96
          Xft.hinting: 1
          Xft.hintstyle: hintfull
          Xft.lcdfilter: lcddefault
          Xft.rgba: rgb
        dest: ~/.Xresources
    
    - name: Fonts -- fonts.conf
      copy:
        content: |
          <match target="font">
            <edit mode="assign" name="rgba"><const>rgb</const></edit>
            <edit mode="assign" name="autohint"><bool>false</bool></edit>
            <edit mode="assign" name="hinting"><bool>true</bool></edit>
            <edit mode="assign" name="hintstyle"><const>hintfull</const></edit>
            <edit mode="assign" name="antialias"><bool>true</bool></edit>
            <edit mode="assign" name="lcdfilter"><const>lcddefault</const></edit>
          </match>
        dest: ~/.config/fontconfig/fonts.conf
    
    - name: Global GTK+ dark theme
      ini_file:
        dest: ~/.config/gtk-3.0/settings.ini
        section: Settings
        option: gtk-application-prefer-dark-theme
        value: 1
    
    - name: dpath -- install with pip (Python) # to enable json module (from jpnewman.json)
      become: yes
      pip:
        name: dpath
        state: latest
        executable: pip2
    
    - name: youtube-dl -- install with pip (Python)
      become: yes
      pip:
        name: youtube-dl
        state: latest
        executable: pip3
    
    - name: Autostart applications
      copy:
        src: /usr/share/applications/{{ item }}.desktop
        dest: ~/.config/autostart/
      with_items:
        - evolution
        - firefox
        - google-chrome
        - guake
        - net.sourceforge.liferea
        - rhythmbox
    
    - name: Set default shell and groups
      become: yes
      user:
        name: ondra
        shell: /usr/bin/fish
        groups: docker
        append: yes
    
    - name: Fish -- oh-my-fish -- install
      shell: curl -L http://get.oh-my.fish | fish /dev/stdin --noninteractive --yes
      args:
        creates: ~/.config/fish/conf.d/omf.fish
    
    - name: Fish -- oh-my-fish -- theme 'bobthefish'
      command: omf install bobthefish ; omf theme bobthefish
      args:
        creates: ~/.local/share/omf/themes/bobthefish
    
    - name: Bin directories -- present
      file:
        path: '~/.local/bin'
        state: directory
    
    - name: Bin directories -- in PATH
      lineinfile:
        line: 'set -g -x PATH {{ item }} $PATH'
        dest: ~/.config/fish/conf.d/path.fish
        create: yes
      with_items:
        - "$HOME/.local/bin"
    
    - name: Environment variables
      lineinfile:
        line: 'set -g -x {{ item.name }} {{ item.value }}'
        dest: ~/.config/fish/conf.d/variables.fish
        create: yes
      with_items:
        - { name: "EDITOR", value: "/usr/bin/gedit" }
    
    - name: sudo on Wayland
      copy:
        content: |
          #!/bin/bash
          xhost +SI:localuser:root
          sudo $1
          xhost -SI:localuser:root
          xhost
        dest: ~/.local/bin/wsudo
        mode: u+x
    
    - name: Flatpack -- add Flathub
      command: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      args:
        creates: /var/lib/flatpak/appstream/flathub
    
    - name: GRUB -- widescreen
      become: yes
      lineinfile:
        dest: /etc/default/grub
        regexp: '^GRUB_GFXMODE='
        insertafter: '^#GRUB_GFXMODE='
        line: 'GRUB_GFXMODE=1920x1080x32'
      register: grubconfigwidescreen
    
    - name: Plymouth -- modesetting kernel modules -- intel_agp
      become: yes
      lineinfile:
        dest: /etc/initramfs-tools/modules
        line: intel_agp
      register: kernelmodulesintelagp
    
    - name: Plymouth -- modesetting kernel modules -- drm
      become: yes
      lineinfile:
        dest: /etc/initramfs-tools/modules
        insertafter: intel_agp
        line: drm
      register: kernelmodulesdrm
    
    - name: Plymouth -- modesetting kernel modules -- i915
      become: yes
      lineinfile:
        dest: /etc/initramfs-tools/modules
        regexp: '^i915 '
        line: 'i915 modeset=1'
      register: kernelmodulesi915
    
    - name: Plymouth -- GRUB config
      become: yes
      lineinfile:
        dest: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
        line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"'
      register: grubconfigplymouth
    
    - name: Plymouth -- set theme
      become: yes
      command: plymouth-set-default-theme -R softwaves
      when: kernelmodulesintelagp.changed or kernelmodulesdrm.changed or kernelmodulesi915.changed
    
    - name: GRUB -- update
      become: yes
      command: update-grub2
      when: grubconfigwidescreen.changed or grubconfigplymouth.changed
    
    - name: Remove Firefox ESR
      become: yes
      package:
        name: firefox-esr
        state: absent
  
  roles:
    - name: zerotao.packages
      become: yes
    
    - alzadude.firefox
    
    - jpnewman.json

